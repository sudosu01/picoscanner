<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PICO APK Privacy Scanner</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { margin-top: 30px; }
    .panel { border:1px solid #ccc; padding:15px; margin-bottom:20px; }
    textarea { width:100%; height:120px; font-family: monospace; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th,td { border:1px solid #ccc; padding:6px; font-size: 13px; vertical-align: top; }
    th { background:#f2f2f2; }
  </style>
</head>
<body>
  <h1>PICO APK Privacy Scanner</h1>

  <div class="panel">
    <h2>Step 1: Pull APK</h2>
    <label>Package:</label> <input id="pkg" size="40"><br>
    <label>APK Path:</label> <input id="apk_path" size="60"><br>
    <label>Destination path:</label> <input id="dest" size="60"><br>
    <button onclick="startPull()">Pull</button>
  </div>

  <div class="panel">
    <h2>Step 2: Decompile APK</h2>
    <label>APK File:</label> <input id="apk_local" size="60"><br>
    <button onclick="startDecompile()">Decompile</button>
  </div>

  <div class="panel">
    <h2>Step 3: Scan Decompiled Folder</h2>
    <label>Decompiled Folder:</label> <input id="decompile_dir" size="60"><br>
    <button onclick="startScan()">Scan</button>
  </div>

  <div class="panel">
    <h2>Logs</h2>
    <textarea id="logs" readonly>No logs yet</textarea>
  </div>

  <div class="panel">
    <h2>Scan Results</h2>
    <div id="results">No results yet</div>
  </div>

<script>
let currentTask=null;
function pollTask(tid,cb){
  fetch('/task_status/'+tid).then(r=>r.json()).then(d=>{
    if(d.logs){document.getElementById('logs').value=d.logs.join("\n");}
    if(d.status==='finished'||d.status==='error'){cb(d);}
    else{setTimeout(()=>pollTask(tid,cb),1000);}
  });
}
function startPull(){
  let data={package:pkg.value,apk_path:apk_path.value,dest_path:dest.value};
  fetch('/start_pull',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})
    .then(r=>r.json()).then(j=>{
      pollTask(j.task_id,d=>{ if(d.meta.local_apk){apk_local.value=d.meta.local_apk;} });
    });
}
function startDecompile(){
  let data={apk_path:apk_local.value};
  fetch('/start_decompile',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})
    .then(r=>r.json()).then(j=>{
      pollTask(j.task_id,d=>{ if(d.meta.decompile_dir){decompile_dir.value=d.meta.decompile_dir;} });
    });
}
function startScan(){
  let data={decompile_dir:decompile_dir.value};
  fetch('/start_scan',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)})
    .then(r=>r.json()).then(j=>{
      pollTask(j.task_id,d=>{
        if(d.meta.results){
          renderResults(d.meta.results);
        }
      });
    });
}
function renderResults(res){
  let html='<table><tr><th>SDK</th><th>Laws</th><th>Found Inits</th><th>Found Privacy APIs</th><th>Missing Privacy APIs</th><th>PVPs</th></tr>';
  for(let r of res){
    html+=`<tr>
      <td>${r.sdk}</td>
      <td>${r.laws}</td>
      <td>${r.found_inits.map(p=>p.path+":"+p.line).join("<br>")||'-'}</td>
      <td>${r.found_privacy_apis.map(p=>p.law+":"+p.api+" ("+p.pos.path+":"+p.pos.line+")").join("<br>")||'-'}</td>
      <td>${r.missing_privacy_apis.join("<br>")||'-'}</td>
      <td>${r.pvp_triggered.join(", ")||'-'}</td>
    </tr>`;
  }
  html+='</table>';
  document.getElementById('results').innerHTML=html;
}
</script>
</body>
</html>
