<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PICO APK Scanner</title>
    <style>
        :root {
            --bg-color: #f5f5f5;
            --text-color: #333;
            --panel-bg: white;
            --panel-border: #ddd;
            --button-bg: #4CAF50;
            --button-hover: #45a049;
            --button-disabled: #ccc;
            --log-bg: #111;
            --log-text: #0f0;
            --status-running: #e6f7ff;
            --status-running-text: #0070c0;
            --status-finished: #e6ffed;
            --status-finished-text: #007000;
            --status-error: #fff2f0;
            --status-error-text: #c00;
            --tab-bg: #f1f1f1;
            --tab-active: #4CAF50;
            --file-browser-bg: white;
            --file-item-hover: #f0f0f0;
            --exact-match-bg: #ffeb3b;
            --file-path-bg: #e6f7ff;
            --finding-bg: #f9f9f9;
            --finding-code-bg: #eee;
            --risk-high: #c00;
            --risk-medium: #c90;
            --risk-low: #090;
        }

        .dark-mode {
            --bg-color: #222;
            --text-color: #f0f0f0;
            --panel-bg: #333;
            --panel-border: #555;
            --button-bg: #2E7D32;
            --button-hover: #1B5E20;
            --button-disabled: #666;
            --log-bg: #000;
            --log-text: #0f0;
            --status-running: #003366;
            --status-running-text: #4fc3f7;
            --status-finished: #006400;
            --status-finished-text: #00e676;
            --status-error: #4a0000;
            --status-error-text: #ff5252;
            --tab-bg: #444;
            --tab-active: #2E7D32;
            --file-browser-bg: #333;
            --file-item-hover: #444;
            --exact-match-bg: #b38f00;
            --file-path-bg: #003366;
            --finding-bg: #3a3a3a;
            --finding-code-bg: #2a2a2a;
            --risk-high: #ff5252;
            --risk-medium: #ffb74d;
            --risk-low: #69f0ae;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .panel {
            background: var(--panel-bg);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid var(--panel-border);
            transition: background-color 0.3s, border-color 0.3s;
        }

        h1, h2, h3 {
            color: var(--text-color);
            transition: color 0.3s;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        th, td {
            border: 1px solid var(--panel-border);
            padding: 8px;
            text-align: left;
            transition: border-color 0.3s;
        }

        th {
            background-color: var(--tab-bg);
            transition: background-color 0.3s;
        }

        #logarea {
            height: 200px;
            overflow: auto;
            background: var(--log-bg);
            color: var(--log-text);
            padding: 10px;
            font-family: monospace;
            border-radius: 4px;
            transition: background-color 0.3s, color 0.3s;
        }

        button {
            background: var(--button-bg);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            transition: background-color 0.3s;
        }

            button:disabled {
                background: var(--button-disabled);
                cursor: not-allowed;
            }

            button:hover:not(:disabled) {
                background: var(--button-hover);
            }

        input[type="text"] {
            padding: 8px;
            border: 1px solid var(--panel-border);
            border-radius: 4px;
            width: 70%;
            margin: 5px 0;
            background-color: var(--panel-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .status {
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px;
            transition: background-color 0.3s, color 0.3s;
        }

        .status-running {
            background: var(--status-running);
            color: var(--status-running-text);
        }

        .status-finished {
            background: var(--status-finished);
            color: var(--status-finished-text);
        }

        .status-error {
            background: var(--status-error);
            color: var(--status-error-text);
        }

        .app-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .progress-container {
            width: 100%;
            background-color: var(--tab-bg);
            border-radius: 4px;
            margin: 10px 0;
            transition: background-color 0.3s;
        }

        .progress-bar {
            height: 10px;
            background-color: var(--button-bg);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }

        .sdk-result {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid var(--panel-border);
            border-radius: 4px;
            transition: border-color 0.3s;
        }

        .sdk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .sdk-details {
            margin-top: 10px;
            display: none;
        }

        .sdk-details.show {
            display: block;
        }

        .finding {
            margin: 5px 0;
            padding: 5px;
            background: var(--finding-bg);
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        .finding-code {
            font-family: monospace;
            background: var(--finding-code-bg);
            padding: 3px;
            border-radius: 3px;
            white-space: pre-wrap;
            max-height: 150px;
            overflow: auto;
            transition: background-color 0.3s;
        }

        .risk-high {
            color: var(--risk-high);
            font-weight: bold;
        }

        .risk-medium {
            color: var(--risk-medium);
        }

        .risk-low {
            color: var(--risk-low);
        }

        .tab {
            overflow: hidden;
            border: 1px solid var(--panel-border);
            background-color: var(--tab-bg);
            border-radius: 4px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 16px;
            transition: 0.3s;
            color: var(--text-color);
        }

        .tab button:hover {
            background-color: var(--file-item-hover);
        }

        .tab button.active {
            background-color: var(--tab-active);
            color: white;
        }

        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid var(--panel-border);
            border-top: none;
            border-radius: 0 0 4px 4px;
            transition: border-color 0.3s;
        }

        .file-browser {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--panel-border);
            padding: 10px;
            margin: 10px 0;
            background-color: var(--file-browser-bg);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .file-item {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid var(--panel-border);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .file-item:hover {
            background-color: var(--file-item-hover);
        }

        .folder-icon:before {
            content: "üìÅ ";
        }

        .file-icon:before {
            content: "üìÑ ";
        }

        .current-path {
            margin: 10px 0;
            padding: 5px;
            background: var(--tab-bg);
            border-radius: 4px;
            font-family: monospace;
            transition: background-color 0.3s;
        }

        .selected-folder {
            background-color: var(--status-running);
            border: 2px solid var(--status-running-text);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .manual-path-input {
            margin: 10px 0;
            padding: 8px;
            width: 70%;
            border: 1px solid var(--panel-border);
            border-radius: 4px;
            background-color: var(--panel-bg);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .live-results {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--panel-border);
            padding: 10px;
            margin: 10px 0;
            transition: border-color 0.3s;
        }

        .current-file {
            margin: 5px 0;
            padding: 3px;
            background: var(--tab-bg);
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
            transition: background-color 0.3s;
        }

        .exact-match {
            background-color: var(--exact-match-bg);
            padding: 2px;
            border-radius: 2px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .file-path {
            font-family: monospace;
            background-color: var(--file-path-bg);
            padding: 3px;
            border-radius: 3px;
            margin-bottom: 5px;
            display: block;
            transition: background-color 0.3s;
        }

        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--button-bg);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: background-color 0.3s;
        }

        .theme-toggle:hover {
            background: var(--button-hover);
        }

        .export-btn {
            background: #2196F3;
        }

        .export-btn:hover {
            background: #0b7dda;
        }

        .finding-count {
            display: inline-block;
            background: var(--button-bg);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            text-align: center;
            line-height: 24px;
            margin-left: 10px;
            font-size: 14px;
        }

        .finding-type {
            font-weight: bold;
            margin-top: 10px;
            border-bottom: 1px solid var(--panel-border);
            padding-bottom: 5px;
            transition: border-color 0.3s;
        }

        .finding-item {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid var(--button-bg);
            background-color: var(--finding-bg);
            border-radius: 4px;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .law-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 5px;
        }

        .law-gdpr {
            background-color: #FF9800;
            color: white;
        }

        .law-us_p {
            background-color: #F44336;
            color: white;
        }

        .law-coppa {
            background-color: #2196F3;
            color: white;
        }

        .law-init {
            background-color: #4CAF50;
            color: white;
        }

        .code-line {
            display: block;
            font-family: monospace;
            white-space: pre;
            margin: 2px 0;
        }

        .highlighted-line {
            background-color: var(--exact-match-bg);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="themeToggle">üåô</button>

    <h1>PICO APK Scanner</h1>

    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'FullProcessTab')">Full Process</button>
        <button class="tablinks" onclick="openTab(event, 'DirectScanTab')">Direct Scan</button>
        <button class="tablinks" onclick="openTab(event, 'ResultsTab')">Results</button>
    </div>

    <!-- Full Process Tab -->
    <div id="FullProcessTab" class="tabcontent" style="display: block;">
        <div class="panel">
            <h3>Device Status</h3>
            <div id="device">Detecting devices...</div>
            <button onclick="refreshDevices()">Refresh Devices</button>
        </div>

        <div class="panel">
            <h3>Installed Apps</h3>
            <div id="appslist">Select a device to view apps</div>
        </div>

        <div class="panel">
            <h3>APK Paths</h3>
            <div id="apkslist">Select an app to view APK files</div>
        </div>

        <div class="panel">
            <h3>Actions</h3>
            <label>APK Destination: <input id="destpath" placeholder="C:\Users\user\Music\Call\app.apk"></label><br>
            <button id="pullbtn" disabled>Pull APK</button>
            <button id="decompilebtn" disabled>Decompile</button>
            <button id="scanbtn" disabled>Scan</button>
            <button id="openfolderbtn" disabled>Open Folder</button>

            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-bar" id="progressBar"></div>
                <div id="progressText" style="text-align: center; margin-top: 5px;">0%</div>
                <div id="currentFile" class="current-file">Current file: None</div>
            </div>
        </div>
    </div>

    <!-- Direct Scan Tab -->
    <div id="DirectScanTab" class="tabcontent">
        <div class="panel">
            <h3>Direct Scan</h3>
            <p>Select a decompiled APK folder to scan directly:</p>
            
            <div class="current-path" id="currentPath">Current path: .</div>
            
            <div class="file-browser" id="fileBrowser">
                <div id="browserContent">Loading...</div>
            </div>
            
            <div id="selectedFolderInfo" style="display: none; margin: 10px 0; padding: 10px; background: var(--status-running); border-radius: 4px;">
                <strong>Selected folder:</strong> <span id="selectedFolderPath"></span>
            </div>
            
            <h4>Or enter path manually:</h4>
            <input type="text" id="manualPathInput" class="manual-path-input" placeholder="C:\path\to\call_decompiled">
            <button onclick="selectManualPath()">Select Manual Path</button>
            
            <br><br>
            <button id="scanDirectBtn" disabled>Start Scan</button>
            <button id="refreshBrowserBtn" onclick="refreshBrowser()">Refresh</button>
            <button id="browseHomeBtn" onclick="loadFileBrowser('.')">Home Directory</button>
            
            <div class="progress-container" id="directProgressContainer" style="display: none;">
                <div class="progress-bar" id="directProgressBar"></div>
                <div id="directProgressText" style="text-align: center; margin-top: 5px;">0%</div>
                <div id="directCurrentFile" class="current-file">Current file: None</div>
            </div>
        </div>
    </div>

    <!-- Results Tab -->
    <div id="ResultsTab" class="tabcontent">
        <div class="panel">
            <h3>Scan Results <span id="resultsCount"></span>
                <button class="export-btn" onclick="exportResults()">Export Results</button>
            </h3>
            <div id="resultsContainer">
                <div id="results">No results yet. Run a scan to see findings.</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h3>Live Scan Progress</h3>
        <div id="liveResults" class="live-results">
            No scan in progress. Results will appear here in real-time.
        </div>
    </div>

    <div class="panel">
        <h3>Logs</h3>
        <div id="logarea"></div>
    </div>

    <script>
        let selectedPackage = null;
        let selectedApkPath = null;
        let lastDecompileDir = null;
        let currentResults = [];
        let expandedSDKs = {};
        let currentBrowserPath = '.';
        let selectedScanFolder = null;
        let currentDevice = null;
        let isDarkMode = false;

        // Theme toggle functionality
        document.getElementById('themeToggle').addEventListener('click', function() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            document.getElementById('themeToggle').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            
            // Save preference to localStorage
            localStorage.setItem('darkMode', isDarkMode);
        });

        // Check for saved theme preference
        if (localStorage.getItem('darkMode') === 'true') {
            isDarkMode = true;
            document.body.classList.add('dark-mode');
            document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
        }

        function api(url, options) {
            return fetch(url, options).then(r => r.json());
        }

        function log(message) {
            const logArea = document.getElementById('logarea');
            logArea.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function showProgress(show, isDirect = false) {
            const container = isDirect ? 'directProgressContainer' : 'progressContainer';
            document.getElementById(container).style.display = show ? 'block' : 'none';
        }

        function updateProgress(percent, isDirect = false) {
            const bar = isDirect ? 'directProgressBar' : 'progressBar';
            const text = isDirect ? 'directProgressText' : 'progressText';
            document.getElementById(bar).style.width = percent + '%';
            document.getElementById(text).innerText = Math.round(percent) + '%';
        }

        function updateCurrentFile(filename, isDirect = false) {
            const element = isDirect ? 'directCurrentFile' : 'currentFile';
            document.getElementById(element).innerText = `Current file: ${filename || 'None'}`;
        }

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            
            // Load file browser when Direct Scan tab is opened
            if (tabName === 'DirectScanTab') {
                loadFileBrowser('.');
            } else if (tabName === 'FullProcessTab') {
                refreshDevices();
            } else if (tabName === 'ResultsTab' && currentResults.length > 0) {
                renderResults(currentResults);
            }
        }

        function refreshDevices() {
            api('/device').then(r => {
                const deviceEl = document.getElementById('device');
                
                if (r.device && r.device.length) {
                    let html = '';
                    r.device.forEach(device => {
                        html += `<span class="status status-finished">${device}</span> `;
                    });
                    deviceEl.innerHTML = html;
                    currentDevice = r.device[0];
                    loadApps();
                } else {
                    deviceEl.innerHTML = '<span class="status status-error">No devices found</span>';
                    currentDevice = null;
                }
            });
        }

        function loadApps() {
            if (!currentDevice) return;
            
            const appsList = document.getElementById('appslist');
            appsList.innerHTML = "Loading apps...";

            api('/list_apps').then(r => {
                if (r.error) {
                    appsList.innerHTML = `<span class="status status-error">${r.error}</span>`;
                    return;
                }

                let html = '<div class="app-list"><table><tr><th>#</th><th>App</th><th>Package</th><th></th></tr>';
                r.apps.forEach(app => {
                    html += `<tr>
                            <td>${app.index}</td>
                            <td>${app.short}</td>
                            <td>${app.package}</td>
                            <td><button onclick="selectApp('${app.package}')">Select</button></td>
                        </tr>`;
                });
                html += '</table></div>';
                appsList.innerHTML = html;
            });
        }

        function loadFileBrowser(path) {
            const browserContent = document.getElementById('browserContent');
            browserContent.innerHTML = "Loading...";
            
            api('/browse_folder?path=' + encodeURIComponent(path)).then(r => {
                if (r.error) {
                    browserContent.innerHTML = `<span class="status status-error">Error: ${r.error}</span>`;
                    return;
                }
                
                currentBrowserPath = r.path;
                document.getElementById('currentPath').innerText = `Current path: ${r.path}`;
                
                let html = '';
                
                // Add parent directory link if not at root
                if (r.path !== '.' && r.path !== '/') {
                    const parentPath = os.path.dirname(r.path);
                    html += `<div class="file-item" onclick="loadFileBrowser('${parentPath}')">
                            <span class="folder-icon"></span>..
                        </div>`;
                }
                
                // Add directories first
                r.items.filter(item => item.is_dir).forEach(item => {
                    html += `<div class="file-item" onclick="selectFolder('${item.path}')">
                            <span class="folder-icon"></span>${item.name}
                        </div>`;
                });
                
                // Then add files (but we're only interested in directories for scanning)
                r.items.filter(item => !item.is_dir).forEach(item => {
                    html += `<div class="file-item">
                            <span class="file-icon"></span>${item.name}
                        </div>`;
                });
                
                if (r.items.length === 0) {
                    html = '<div class="file-item">No items found in this directory</div>';
                }
                
                browserContent.innerHTML = html;
            }).catch(err => {
                browserContent.innerHTML = `<span class="status status-error">Error loading directory: ${err}</span>`;
            });
        }
        
        function refreshBrowser() {
            loadFileBrowser(currentBrowserPath);
        }
        
        function selectFolder(path) {
            selectedScanFolder = path;
            
            // Update UI to show selected folder
            document.getElementById('selectedFolderInfo').style.display = 'block';
            document.getElementById('selectedFolderPath').textContent = path;
            
            // Enable scan button
            document.getElementById('scanDirectBtn').disabled = false;
            
            log(`Selected folder: ${path}`);
            
            // Highlight the selected folder
            const items = document.querySelectorAll('.file-item');
            items.forEach(item => {
                item.classList.remove('selected-folder');
                if (item.textContent.includes(path.split('/').pop().split('\\').pop())) {
                    item.classList.add('selected-folder');
                }
            });
        }
        
        function selectManualPath() {
            const manualPath = document.getElementById('manualPathInput').value;
            if (!manualPath) {
                alert("Please enter a folder path");
                return;
            }
            
            // Test if the path exists by trying to browse it
            api('/browse_folder?path=' + encodeURIComponent(manualPath)).then(r => {
                if (r.error) {
                    log(`Error: ${r.error}`);
                    alert(`Invalid path: ${r.error}`);
                    return;
                }
                
                selectedScanFolder = manualPath;
                
                // Update UI to show selected folder
                document.getElementById('selectedFolderInfo').style.display = 'block';
                document.getElementById('selectedFolderPath').textContent = manualPath;
                
                // Enable scan button
                document.getElementById('scanDirectBtn').disabled = false;
                
                log(`Selected folder: ${manualPath}`);
            }).catch(err => {
                log(`Error: ${err}`);
                alert(`Invalid path: ${err}`);
            });
        }

        function selectApp(pkg) {
            selectedPackage = pkg;
            log(`Selected app: ${pkg}`);

            const apksList = document.getElementById('apkslist');
            apksList.innerHTML = "Loading APK paths...";

            api('/apk_paths?package=' + encodeURIComponent(pkg)).then(r => {
                if (r.paths && r.paths.length) {
                    let html = '<table><tr><th>Path</th><th></th></tr>';
                    r.paths.forEach((path, i) => {
                        html += `<tr>
                                <td>${path}</td>
                                <td><button onclick="selectApk('${path}')">Select</button></td>
                            </tr>`;
                    });
                    html += '</table>';
                    apksList.innerHTML = html;
                } else {
                    apksList.innerHTML = "No APK paths found";
                }
            });
        }

        function selectApk(path) {
            selectedApkPath = path;
            document.getElementById('pullbtn').disabled = false;
            log(`Selected APK: ${path}`);
        }

        document.getElementById('pullbtn').onclick = function () {
            const dest = document.getElementById('destpath').value;
            if (!dest) {
                alert("Please enter a destination path");
                return;
            }

            showProgress(true);
            updateProgress(10);
            log(`Pulling APK to ${dest}`);

            api('/start_pull', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    package: selectedPackage,
                    apk_path: selectedApkPath,
                    dest_path: dest
                })
            }).then(r => {
                pollTask(r.task_id, data => {
                    if (data.meta && data.meta.apk) {
                        document.getElementById('destpath').value = data.meta.apk;
                        document.getElementById('decompilebtn').disabled = false;
                        updateProgress(50);
                    }
                    showProgress(false);
                });
            });
        };

        document.getElementById('decompilebtn').onclick = function () {
            const apkPath = document.getElementById('destpath').value;
            if (!apkPath) {
                alert("No APK selected");
                return;
            }

            showProgress(true);
            updateProgress(60);
            log(`Decompiling ${apkPath}`);

            api('/start_decompile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ apk_path: apkPath })
            }).then(r => {
                pollTask(r.task_id, data => {
                    if (data.meta && data.meta.decompile_dir) {
                        lastDecompileDir = data.meta.decompile_dir;
                        document.getElementById('scanbtn').disabled = false;
                        document.getElementById('openfolderbtn').disabled = false;
                        updateProgress(80);
                    }
                    showProgress(false);
                });
            });
        };

        document.getElementById('scanbtn').onclick = function () {
            if (!lastDecompileDir) {
                alert("No decompiled directory available");
                return;
            }

            showProgress(true);
            updateProgress(5);
            log(`Starting scan of ${lastDecompileDir}`);

            api('/start_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ decompile_dir: lastDecompileDir })
            }).then(r => {
                pollTask(r.task_id, data => {
                    if (data.meta) {
                        if (data.meta.progress) {
                            updateProgress(data.meta.progress);
                        }
                        
                        if (data.meta.partial_results) {
                            renderResults(data.meta.partial_results);
                            updateLiveResults(data.meta.partial_results);
                        }
                        
                        if (data.meta.current_file) {
                            updateCurrentFile(data.meta.current_file);
                        }
                        
                        if (data.meta.results) {
                            currentResults = data.meta.results;
                            renderResults(currentResults);
                            updateProgress(100);
                            setTimeout(() => showProgress(false), 1000);
                            
                            // Switch to results tab
                            document.querySelector('.tablinks.active').click();
                            document.querySelector('[onclick="openTab(event, \'ResultsTab\')"]').click();
                        }
                    }
                });
            });
        };

        document.getElementById('scanDirectBtn').onclick = function () {
            if (!selectedScanFolder) {
                alert("No folder selected for scanning");
                return;
            }

            showProgress(true, true);
            updateProgress(5, true);
            log(`Starting direct scan of ${selectedScanFolder}`);

            api('/start_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ decompile_dir: selectedScanFolder })
            }).then(r => {
                pollTask(r.task_id, data => {
                    if (data.meta) {
                        if (data.meta.progress) {
                            updateProgress(data.meta.progress, true);
                        }
                        
                        if (data.meta.partial_results) {
                            renderResults(data.meta.partial_results);
                            updateLiveResults(data.meta.partial_results);
                        }
                        
                        if (data.meta.current_file) {
                            updateCurrentFile(data.meta.current_file, true);
                        }
                        
                        if (data.meta.results) {
                            currentResults = data.meta.results;
                            renderResults(currentResults);
                            updateProgress(100, true);
                            setTimeout(() => showProgress(false, true), 1000);
                            
                            // Switch to results tab
                            document.querySelector('.tablinks.active').click();
                            document.querySelector('[onclick="openTab(event, \'ResultsTab\')"]').click();
                        }
                    }
                });
            });
        };

        document.getElementById('openfolderbtn').onclick = function () {
            if (!lastDecompileDir) {
                alert("No decompiled directory available");
                return;
            }

            api('/open_folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: lastDecompileDir })
            }).then(r => {
                if (r.status === 'opened') {
                    log(`Opened folder: ${lastDecompileDir}`);
                } else {
                    log(`Error opening folder: ${r.error}`);
                }
            });
        };

        function pollTask(task_id, callback) {
            const checkTask = () => {
                api('/task_status/' + task_id).then(data => {
                    if (data.status === 'finished' || data.status === 'error') {
                        callback(data);
                        return;
                    }
                    
                    // Update logs
                    if (data.logs && data.logs.length) {
                        data.logs.forEach(logEntry => {
                            if (!logEntry.processed) {
                                log(logEntry);
                                logEntry.processed = true;
                            }
                        });
                    }
                    
                    callback(data);
                    setTimeout(checkTask, 1000);
                });
            };
            checkTask();
        }

        function updateLiveResults(results) {
            const liveResults = document.getElementById('liveResults');
            let html = '';
            
            if (results && results.length) {
                html = '<h4>Live Findings:</h4>';
                
                results.forEach(sdk => {
                    const totalFindings = sdk.found_inits.length + sdk.found_privacy_apis.length;
                    if (totalFindings > 0) {
                        html += `<div class="sdk-result">
                            <div class="sdk-header" onclick="toggleSdkDetails('${sdk.sdk}')">
                                <strong>${sdk.sdk}</strong> 
                                <span class="finding-count">${totalFindings}</span>
                            </div>
                        </div>`;
                    }
                });
            } else {
                html = 'No findings yet. Scanning in progress...';
            }
            
            liveResults.innerHTML = html;
        }

        function toggleSdkDetails(sdkName) {
            expandedSDKs[sdkName] = !expandedSDKs[sdkName];
            renderResults(currentResults);
        }

        function renderResults(results) {
            const resultsContainer = document.getElementById('results');
            const resultsCount = document.getElementById('resultsCount');
            
            if (!results || results.length === 0) {
                resultsContainer.innerHTML = 'No results yet. Run a scan to see findings.';
                resultsCount.innerHTML = '';
                return;
            }
            
            let html = '';
            let totalFindings = 0;
            let totalPVPs = 0;
            
            results.forEach(sdk => {
                const sdkFindings = sdk.found_inits.length + sdk.found_privacy_apis.length;
                totalFindings += sdkFindings;
                totalPVPs += sdk.pvp_triggered.length;
                
                html += `<div class="sdk-result">
                    <div class="sdk-header" onclick="toggleSdkDetails('${sdk.sdk}')">
                        <div>
                            <strong>${sdk.sdk}</strong> - ${sdk.laws}
                            <span class="finding-count">${sdkFindings}</span>
                        </div>
                        <div>${sdk.pvp_triggered.length > 0 ? 
                            `<span class="risk-high">${sdk.pvp_triggered.join(', ')}</span>` : 
                            '<span class="risk-low">No PVP</span>'}</div>
                    </div>`;
                
                if (expandedSDKs[sdk.sdk]) {
                    html += `<div class="sdk-details show">`;
                    
                    // Show initialization findings
                    if (sdk.found_inits.length > 0) {
                        html += `<div class="finding-type">Initialization Patterns Found (${sdk.found_inits.length}):</div>`;
                        sdk.found_inits.forEach((finding, index) => {
                            html += `<div class="finding-item">
                                <span class="law-badge law-init">INIT</span>
                                <span class="file-path">${finding.path}:${finding.line}</span>
                                <div class="finding-code">${formatCodeSnippet(finding.code, finding.exact_match)}</div>
                            </div>`;
                        });
                    }
                    
                    // Show privacy API findings
                    if (sdk.found_privacy_apis.length > 0) {
                        html += `<div class="finding-type">Privacy APIs Found (${sdk.found_privacy_apis.length}):</div>`;
                        sdk.found_privacy_apis.forEach((finding, index) => {
                            const lawClass = `law-${finding.law}`;
                            html += `<div class="finding-item">
                                <span class="law-badge ${lawClass}">${finding.law.toUpperCase()}</span>
                                <span class="file-path">${finding.path}:${finding.line}</span>
                                <div class="finding-code">${formatCodeSnippet(finding.code, finding.exact_match)}</div>
                            </div>`;
                        });
                    }
                    
                    // Show missing APIs
                    if (sdk.missing_privacy_apis.length > 0) {
                        html += `<div class="finding-type">Missing Privacy APIs (${sdk.missing_privacy_apis.length}):</div>`;
                        html += `<div class="finding">${sdk.missing_privacy_apis.join(', ')}</div>`;
                    }
                    
                    html += `</div>`; // Close sdk-details
                }
                
                html += `</div>`; // Close sdk-result
            });
            
            resultsCount.innerHTML = `- ${totalFindings} findings, ${totalPVPs} PVPs triggered`;
            resultsContainer.innerHTML = html;
        }

        function formatCodeSnippet(code, exactMatch) {
            // Split code into lines and highlight the exact match
            const lines = code.split('\n');
            let formattedCode = '';
            
            lines.forEach(line => {
                if (line.includes(exactMatch)) {
                    formattedCode += `<div class="code-line highlighted-line">${escapeHtml(line)}</div>`;
                } else {
                    formattedCode += `<div class="code-line">${escapeHtml(line)}</div>`;
                }
            });
            
            return formattedCode;
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function exportResults() {
            if (!currentResults || currentResults.length === 0) {
                alert("No results to export");
                return;
            }
            
            const dataStr = JSON.stringify(currentResults, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `picoscan_results_${new Date().toISOString().slice(0,10)}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        // Initialize
        refreshDevices();
        loadFileBrowser('.');
    </script>
</body>
</html>
