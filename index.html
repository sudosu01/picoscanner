<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>PICO APK Scanner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .panel {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h1, h2, h3 {
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        #logarea {
            height: 200px;
            overflow: auto;
            background: #111;
            color: #0f0;
            padding: 10px;
            font-family: monospace;
            border-radius: 4px;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

            button:disabled {
                background: #ccc;
                cursor: not-allowed;
            }

            button:hover:not(:disabled) {
                background: #45a049;
            }

        input[type="text"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 70%;
            margin: 5px 0;
        }

        .status {
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin: 5px;
        }

        .status-running {
            background: #e6f7ff;
            color: #0070c0;
        }

        .status-finished {
            background: #e6ffed;
            color: #007000;
        }

        .status-error {
            background: #fff2f0;
            color: #c00;
        }

        .app-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .progress-container {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 4px;
            margin: 10px 0;
        }

        .progress-bar {
            height: 10px;
            background-color: #4CAF50;
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s;
        }

        .sdk-result {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .sdk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .sdk-details {
            margin-top: 10px;
            display: none;
        }

        .sdk-details.show {
            display: block;
        }

        .finding {
            margin: 5px 0;
            padding: 5px;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .finding-code {
            font-family: monospace;
            background: #eee;
            padding: 3px;
            border-radius: 3px;
        }

        .risk-high {
            color: #c00;
            font-weight: bold;
        }

        .risk-medium {
            color: #c90;
        }

        .risk-low {
            color: #090;
        }

        .tab {
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
            border-radius: 4px;
        }

        .tab button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 10px 16px;
            transition: 0.3s;
            color: #333;
        }

        .tab button:hover {
            background-color: #ddd;
        }

        .tab button.active {
            background-color: #4CAF50;
            color: white;
        }

        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }

        .file-browser {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
        }

        .file-item {
            padding: 5px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .file-item:hover {
            background-color: #f0f0f0;
        }

        .folder-icon:before {
            content: "üìÅ ";
        }

        .file-icon:before {
            content: "üìÑ ";
        }
    </style>
</head>
<body>
    <h1>PICO APK Scanner</h1>

    <div class="tab">
        <button class="tablinks active" onclick="openTab(event, 'FullProcessTab')">Full Process</button>
        <button class="tablinks" onclick="openTab(event, 'DirectScanTab')">Direct Scan</button>
    </div>

    <!-- Full Process Tab -->
    <div id="FullProcessTab" class="tabcontent" style="display: block;">
        <div class="panel">
            <h3>Device Status</h3>
            <div id="device">Detecting...</div>
        </div>

        <div class="panel">
            <h3>Installed Apps</h3>
            <div id="appslist">Loading...</div>
        </div>

        <div class="panel">
            <h3>APK Paths</h3>
            <div id="apkslist">Select an app to view APK files</div>
        </div>

        <div class="panel">
            <h3>Actions</h3>
            <label>APK Destination: <input id="destpath" placeholder="C:\Users\user\Music\Call\app.apk"></label><br>
            <button id="pullbtn" disabled>Pull APK</button>
            <button id="decompilebtn" disabled>Decompile</button>
            <button id="scanbtn" disabled>Scan</button>
            <button id="openfolderbtn" disabled>Open Folder</button>

            <div class="progress-container" id="progressContainer" style="display: none;">
                <div class="progress-bar" id="progressBar"></div>
                <div id="progressText" style="text-align: center; margin-top: 5px;">0%</div>
            </div>
        </div>
    </div>

    <!-- Direct Scan Tab -->
    <div id="DirectScanTab" class="tabcontent">
        <div class="panel">
            <h3>Direct Scan</h3>
            <p>Select a decompiled APK folder to scan directly:</p>
            
            <div class="file-browser" id="fileBrowser">
                <div id="browserContent">Loading...</div>
            </div>
            
            <button id="selectFolderBtn" disabled>Select This Folder</button>
            <button id="scanDirectBtn" disabled>Start Scan</button>
            <button id="refreshBrowserBtn" onclick="refreshBrowser()">Refresh</button>
            
            <div class="progress-container" id="directProgressContainer" style="display: none;">
                <div class="progress-bar" id="directProgressBar"></div>
                <div id="directProgressText" style="text-align: center; margin-top: 5px;">0%</div>
            </div>
        </div>
    </div>

    <div class="panel">
        <h3>Logs</h3>
        <div id="logarea"></div>
    </div>

    <div class="panel">
        <h3>Scan Results <span id="resultsCount"></span></h3>
        <div id="results">No results yet</div>
    </div>

    <script>
        let selectedPackage = null;
        let selectedApkPath = null;
        let lastDecompileDir = null;
        let currentResults = [];
        let expandedSDKs = {};
        let currentBrowserPath = '.';
        let selectedScanFolder = null;

        function api(url, options) {
            return fetch(url, options).then(r => r.json());
        }

        function log(message) {
            const logArea = document.getElementById('logarea');
            logArea.innerHTML += `[${new Date().toLocaleTimeString()}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function showProgress(show, isDirect = false) {
            const container = isDirect ? 'directProgressContainer' : 'progressContainer';
            document.getElementById(container).style.display = show ? 'block' : 'none';
        }

        function updateProgress(percent, isDirect = false) {
            const bar = isDirect ? 'directProgressBar' : 'progressBar';
            const text = isDirect ? 'directProgressText' : 'progressText';
            document.getElementById(bar).style.width = percent + '%';
            document.getElementById(text).innerText = Math.round(percent) + '%';
        }

        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
            
            // Load file browser when Direct Scan tab is opened
            if (tabName === 'DirectScanTab') {
                loadFileBrowser('.');
            }
        }

        function loadFileBrowser(path) {
            const browserContent = document.getElementById('browserContent');
            browserContent.innerHTML = "Loading...";
            
            api('/browse_folder?path=' + encodeURIComponent(path)).then(r => {
                if (r.error) {
                    browserContent.innerHTML = `<span class="status status-error">${r.error}</span>`;
                    return;
                }
                
                currentBrowserPath = r.path;
                let html = '';
                
                // Add parent directory link if not at root
                if (r.path !== '.') {
                    const parentPath = r.path.split('/').slice(0, -1).join('/') || '.';
                    html += `<div class="file-item" onclick="loadFileBrowser('${parentPath}')">
                            <span class="folder-icon"></span>..
                        </div>`;
                }
                
                // Add directories first
                r.items.filter(item => item.is_dir).forEach(item => {
                    html += `<div class="file-item" onclick="loadFileBrowser('${item.path}')">
                            <span class="folder-icon"></span>${item.name}
                        </div>`;
                });
                
                // Then add files
                r.items.filter(item => !item.is_dir).forEach(item => {
                    html += `<div class="file-item" onclick="selectFolder('${item.path}')">
                            <span class="file-icon"></span>${item.name}
                        </div>`;
                });
                
                browserContent.innerHTML = html;
            });
        }
        
        function refreshBrowser() {
            loadFileBrowser(currentBrowserPath);
        }
        
        function selectFolder(path) {
            selectedScanFolder = path;
            document.getElementById('selectFolderBtn').disabled = false;
            document.getElementById('scanDirectBtn').disabled = false;
            log(`Selected folder: ${path}`);
        }

        function detectDevice() {
            api('/device').then(r => {
                const deviceEl = document.getElementById('device');
                deviceEl.innerHTML = r.device ?
                    `<span class="status status-finished">Connected: ${r.device}</span>` :
                    `<span class="status status-error">No device connected</span>`;
                loadApps();
            });
        }

        function loadApps() {
            const appsList = document.getElementById('appslist');
            appsList.innerHTML = "Loading apps...";

            api('/list_apps').then(r => {
                if (r.error) {
                    appsList.innerHTML = `<span class="status status-error">${r.error}</span>`;
                    return;
                }

                let html = '<div class="app-list"><table><tr><th>#</th><th>App</th><th>Package</th><th></th></tr>';
                r.apps.forEach(app => {
                    html += `<tr>
                            <td>${app.index}</td>
                            <td>${app.short}</td>
                            <td>${app.package}</td>
                            <td><button onclick="selectApp('${app.package}')">Select</button></td>
                        </tr>`;
                });
                html += '</table></div>';
                appsList.innerHTML = html;
            });
        }

        function selectApp(pkg) {
            selectedPackage = pkg;
            log(`Selected app: ${pkg}`);

            const apksList = document.getElementById('apkslist');
            apksList.innerHTML = "Loading APK paths...";

            api('/apk_paths?package=' + encodeURIComponent(pkg)).then(r => {
                if (r.paths && r.paths.length) {
                    let html = '<table><tr><th>Path</th><th></th></tr>';
                    r.paths.forEach((path, i) => {
                        html += `<tr>
                                <td>${path}</td>
                                <td><button onclick="selectApk('${path}')">Select</button></td>
                            </tr>`;
                    });
                    html += '</table>';
                    apksList.innerHTML = html;
                } else {
                    apksList.innerHTML = "No APK paths found";
                }
            });
        }

        function selectApk(path) {
            selectedApkPath = path;
            document.getElementById('pullbtn').disabled = false;
            log(`Selected APK: ${path}`);
        }

        document.getElementById('pullbtn').onclick = function () {
            const dest = document.getElementById('destpath').value;
            if (!dest) {
                alert("Please enter a destination path");
                return;
            }

            showProgress(true);
            updateProgress(10);
            log(`Pulling APK to ${dest}`);

            api('/start_pull', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    package: selectedPackage,
                    apk_path: selectedApkPath,
                    dest_path: dest
                })
            }).then(r => {
                pollTask(r.task_id, data => {
                    if (data.meta && data.meta.apk) {
                        document.getElementById('destpath').value = data.meta.apk;
                        document.getElementById('decompilebtn').disabled = false;
                        updateProgress(50);
                    }
                    showProgress(false);
                });
            });
        };

        document.getElementById('decompilebtn').onclick = function () {
            const apkPath = document.getElementById('destpath').value;
            if (!apkPath) {
                alert("No APK selected");
                return;
            }

            showProgress(true);
            updateProgress(60);
            log(`Decompiling ${apkPath}`);

            api('/start_decompile', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ apk_path: apkPath })
            }).then(r => {
                pollTask(r.task_id, data => {
                    if (data.meta && data.meta.decompile_dir) {
                        lastDecompileDir = data.meta.decompile_dir;
                        document.getElementById('scanbtn').disabled = false;
                        document.getElementById('openfolderbtn').disabled = false;
                        updateProgress(80);
                    }
                    showProgress(false);
                });
            });
        };

        document.getElementById('scanbtn').onclick = function () {
            if (!lastDecompileDir) {
                alert("No decompiled directory available");
                return;
            }

            showProgress(true);
            updateProgress(5);
            log(`Starting scan of ${lastDecompileDir}`);

            api('/start_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ decompile_dir: lastDecompileDir })
            }).then(r => {
                pollTask(r.task_id, data => {
                    if (data.meta) {
                        if (data.meta.progress) {
                            updateProgress(data.meta.progress);
                        }
                        
                        if (data.meta.partial_results) {
                            renderResults(data.meta.partial_results);
                        }
                        
                        if (data.meta.results) {
                            currentResults = data.meta.results;
                            renderResults(currentResults);
                            updateProgress(100);
                            setTimeout(() => showProgress(false), 1000);
                        }
                    }
                });
            });
        };

        document.getElementById('scanDirectBtn').onclick = function () {
            if (!selectedScanFolder) {
                alert("No folder selected for scanning");
                return;
            }

            showProgress(true, true);
            updateProgress(5, true);
            log(`Starting direct scan of ${selectedScanFolder}`);

            api('/start_scan', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ decompile_dir: selectedScanFolder })
            }).then(r => {
                pollTask(r.task_id, data => {
                    if (data.meta) {
                        if (data.meta.progress) {
                            updateProgress(data.meta.progress, true);
                        }
                        
                        if (data.meta.partial_results) {
                            renderResults(data.meta.partial_results);
                        }
                        
                        if (data.meta.results) {
                            currentResults = data.meta.results;
                            renderResults(currentResults);
                            updateProgress(100, true);
                            setTimeout(() => showProgress(false, true), 1000);
                        }
                    }
                }, true);
            });
        };

        document.getElementById('selectFolderBtn').onclick = function () {
            if (selectedScanFolder) {
                api('/open_folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ path: selectedScanFolder })
                }).then(r => {
                    if (r.error) {
                        log(`Error: ${r.error}`);
                    } else {
                        log("Folder opened");
                    }
                });
            }
        };

        document.getElementById('openfolderbtn').onclick = function () {
            if (!lastDecompileDir) {
                alert("No folder to open");
                return;
            }

            api('/open_folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ path: lastDecompileDir })
            }).then(r => {
                if (r.error) {
                    log(`Error: ${r.error}`);
                } else {
                    log("Folder opened");
                }
            });
        };

        function pollTask(taskId, callback, isDirect = false) {
            const interval = setInterval(() => {
                api('/task_status/' + taskId).then(data => {
                    if (data.logs) {
                        data.logs.forEach(logEntry => {
                            if (!logEntry.includes('PICO APK Scanner')) {
                                log(logEntry);
                            }
                        });
                    }

                    if (['finished', 'error'].includes(data.status)) {
                        clearInterval(interval);
                        callback(data);
                    } else {
                        callback(data);
                    }
                });
            }, 1000);
        }

        function toggleSDK(sdk) {
            expandedSDKs[sdk] = !expandedSDKs[sdk];
            renderResults(currentResults);
        }

        function renderResults(results) {
            if (!results || results.length === 0) {
                document.getElementById('results').innerHTML = "No results found";
                document.getElementById('resultsCount').innerText = '';
                return;
            }

            document.getElementById('resultsCount').innerText = `(${results.length} SDKs analyzed)`;
            
            let html = '';
            let pvpCount = 0;
            let findingCount = 0;

            results.forEach(r => {
                const findings = r.found_inits.length + r.found_privacy_apis.length;
                const missing = r.missing_privacy_apis.length;
                const pvps = r.pvp_triggered.length;
                
                pvpCount += pvps;
                findingCount += findings;

                const riskLevel = pvps > 0 ? 'high' : (missing > 0 ? 'medium' : 'low');
                
                html += `
                <div class="sdk-result">
                    <div class="sdk-header" onclick="toggleSDK('${r.sdk}')">
                        <div>
                            <strong>${r.sdk}</strong> 
                            <span class="risk-${riskLevel}">(${r.laws})</span>
                        </div>
                        <div>
                            <span class="status">${findings} findings, ${missing} missing, ${pvps} PVPs</span>
                            <button>${expandedSDKs[r.sdk] ? 'Collapse' : 'Expand'}</button>
                        </div>
                    </div>
                    <div class="sdk-details ${expandedSDKs[r.sdk] ? 'show' : ''}">
                        <h4>Initialization Patterns Found:</h4>
                        ${r.found_inits.length > 0 ? 
                            r.found_inits.map(init => `
                                <div class="finding">
                                    <strong>${init.path}</strong><br>
                                    <div class="finding-code">${init.code}</div>
                                </div>
                            `).join('') : 
                            '<p>No initialization patterns found</p>'
                        }
                        
                        <h4>Privacy APIs Found:</h4>
                        ${r.found_privacy_apis.length > 0 ? 
                            r.found_privacy_apis.map(api => `
                                <div class="finding">
                                    <strong>${api.law}:</strong> ${api.api} in ${api.pos.path}<br>
                                    <div class="finding-code">${api.pos.code}</div>
                                </div>
                            `).join('') : 
                            '<p>No privacy APIs found</p>'
                        }
                        
                        <h4>Missing Privacy APIs:</h4>
                        ${r.missing_privacy_apis.length > 0 ? 
                            `<ul>${r.missing_privacy_apis.map(m => `<li>${m}</li>`).join('')}</ul>` : 
                            '<p>No missing privacy APIs</p>'
                        }
                        
                        <h4>PVP Triggers:</h4>
                        ${r.pvp_triggered.length > 0 ? 
                            `<ul>${r.pvp_triggered.map(pvp => `<li class="risk-high">${pvp}</li>`).join('')}</ul>` : 
                            '<p>No PVP triggers</p>'
                        }
                    </div>
                </div>
                `;
            });

            // Add summary at the top
            const summaryHtml = `
                <div class="sdk-result" style="background-color: #f8f8f8;">
                    <h3>Scan Summary</h3>
                    <p>Total SDKs analyzed: ${results.length}</p>
                    <p>Total findings: ${findingCount}</p>
                    <p class="${pvpCount > 0 ? 'risk-high' : 'risk-low'}">Total PVP triggers: ${pvpCount}</p>
                </div>
            `;

            document.getElementById('results').innerHTML = summaryHtml + html;
        }

        // Initialize
        detectDevice();
    </script>
</body>
</html>
